<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <title>Admin - User Management</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="card shadow">
    <div class="card-body">
<div class="d-flex align-items-center mb-3">
  <a href="dashboard.html" class="me-2 text-dark" style="text-decoration:none; font-size:22px;">
    ‚Üê
  </a>
  <h4 class="mb-0">User Management</h4>
</div>
      <!-- BUTTON ADD USER -->
      <div class="d-flex justify-content-between mt-3">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
          + Add User
        </button>
      </div>

      <!-- TABLE -->
      <table class="table mt-3">
        <thead>
          <tr>
            <th>ID</th>
            <th>Nama</th>
            <th>Username</th>
            <th>Role</th>
            <th>Action</th>
          </tr>
        </thead>
        <tbody id="userTable"></tbody>
      </table>
    </div>
  </div>
</div>

<!-- =========================
        MODAL ADD USER
========================= -->
<div class="modal fade" id="addUserModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Add New User</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <div class="mb-3">
          <label>Nama</label>
          <input type="text" id="name" class="form-control">
        </div>

        <div class="mb-3">
          <label>Username</label>
          <input type="text" id="username" class="form-control">
        </div>

        <div class="mb-3">
          <label>Password</label>
          <input type="password" id="password" class="form-control">
        </div>

        <div class="mb-3">
          <label>Role</label>
          <select id="role" class="form-select">
            <option value="user">User</option>
            <option value="admin">Admin</option>
          </select>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        <button class="btn btn-primary" onclick="addUser()">Save</button>
      </div>

    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

<script>
const currentUser = JSON.parse(localStorage.getItem("user"));

// Proteksi hanya admin
if (!currentUser || currentUser.role !== "admin") {
  window.location.href = "login.html";
}

/* ======================
   LOAD USERS
====================== */
function loadUsers() {
  fetch("http://localhost:3000/users")
    .then(res => res.json())
    .then(data => {

      const table = document.getElementById("userTable");
      table.innerHTML = "";

      data.forEach(u => {
        table.innerHTML += `
          <tr>
            <td>${u.id}</td>
            <td>${u.name || "-"}</td>
            <td>${u.username}</td>
            <td>${u.role}</td>
            <td>
              <button class="btn btn-danger btn-sm"
                onclick="deleteUser('${u.id}')">
                Delete
              </button>
            </td>
          </tr>
        `;
      });
    });
}

/* ======================
   GENERATE UID SEQUENTIAL
====================== */
async function generateUID() {

  const res = await fetch("http://localhost:3000/users");
  const users = await res.json();

  if (users.length === 0) return "UID-001";

  const numbers = users.map(u => {
    const parts = u.id.split("-");
    return parseInt(parts[1]);
  });

  const maxNumber = Math.max(...numbers);
  const nextNumber = String(maxNumber + 1).padStart(3, "0");

  return "UID-" + nextNumber;
}

/* ======================
   ADD USER
====================== */
async function addUser() {

  const name = document.getElementById("name").value.trim();
  const username = document.getElementById("username").value.trim();
  const password = document.getElementById("password").value.trim();
  const role = document.getElementById("role").value;

  if (!name || !username || !password) {
    alert("Semua field wajib diisi!");
    return;
  }

  const res = await fetch("http://localhost:3000/users");
  const users = await res.json();

  const exists = users.find(u => u.username === username);
  if (exists) {
    alert("Username sudah digunakan!");
    return;
  }

  const newId = await generateUID();

  await fetch("http://localhost:3000/users", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      id: newId,
      name,
      username,
      password,
      role
    })
  });

  alert("User berhasil ditambahkan!");

  // Reset form
  document.getElementById("name").value = "";
  document.getElementById("username").value = "";
  document.getElementById("password").value = "";

  // Close modal
  const modal = bootstrap.Modal.getInstance(document.getElementById('addUserModal'));
  modal.hide();

  loadUsers();
}

/* ======================
   DELETE USER
====================== */
function deleteUser(id) {

  if (id === currentUser.id) {
    alert("Tidak bisa menghapus akun sendiri!");
    return;
  }

  if (!confirm("Yakin mau hapus user ini?")) return;

  fetch(`http://localhost:3000/users/${id}`, {
    method: "DELETE"
  }).then(() => loadUsers());
}

loadUsers();
</script>

</body>
</html>
