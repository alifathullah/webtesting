<!DOCTYPE html>
<html>
  <head>
    <title>Register</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <link rel="stylesheet" href="style.css">
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-4">
          <div class="card shadow">
            <div class="card-body">
              <h4 class="text-center mb-4">Register</h4>

              <div class="mb-3">
                <label>Nama Lengkap</label>
                <input type="text" id="name" class="form-control">
              </div>

              <div class="mb-3">
                <label>Username</label>
                <input type="text" id="username" class="form-control">
              </div>

              <div class="mb-3">
                <label>Email</label>
                <input type="email" id="email" class="form-control">
              </div>

              <div class="mb-3">
                <label>Nomor HP</label>
                <input type="tel" id="phone" class="form-control">
              </div>

              <div class="mb-3">
                <label>Foto Profil (Opsional)</label>
                <input
                  type="file"
                  id="photoFile"
                  class="form-control"
                  accept="image/*"
                >
                <div class="form-text">
                  Pilih gambar (JPG/PNG). Disimpan sebagai base64.
                </div>
              </div>

              <div class="mb-3">
                <label>Password</label>
                <input type="password" id="password" class="form-control">
              </div>

              <div class="mb-3">
                <label>Confirm Password</label>
                <input type="password" id="confirmPassword" class="form-control">
              </div>

              <div id="error" class="text-danger mb-3"></div>
              <div id="success" class="text-success mb-3"></div>

              <button class="btn btn-success w-100" onclick="register()">
                Register
              </button>

              <div class="text-center mt-3">
                <a href="login.html">Sudah punya akun? Login</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function generateUID() {
        const res = await fetch("http://localhost:3000/users");
        const users = await res.json();

        if (users.length === 0) return "UID-001";

        const numbers = users.map(u => {
          if (!u.id) return 0;
          return parseInt(u.id.split("-")[1]) || 0;
        });

        const maxNumber = Math.max(...numbers);
        const nextNumber = String(maxNumber + 1).padStart(3, "0");

        return "UID-" + nextNumber;
      }

      async function addLog(prefix, action, username, targetId = "-", targetName = "-") {
        const now = new Date();

        const day = String(now.getDate()).padStart(2, "0");
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const year = String(now.getFullYear()).slice(-2);

        const datePrefix = day + month + year;

        const response = await fetch("http://localhost:3000/logs");
        const data = await response.json();

        const todayLogs = data.filter(
          log =>
            log?.id &&
            log.id.startsWith(prefix + "-" + datePrefix)
        );

        let maxNumber = 0;
        todayLogs.forEach(log => {
          const parts = (log.id || "").split("-");
          const number = parseInt(parts[2], 10) || 0;
          if (number > maxNumber) {
            maxNumber = number;
          }
        });

        const nextNumber = String(maxNumber + 1).padStart(3, "0");
        const newId = prefix + "-" + datePrefix + "-" + nextNumber;

        await fetch("http://localhost:3000/logs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: newId,
            username: username,
            action: action,
            targetId: targetId,
            targetName: targetName,
            date: now.toLocaleString()
          })
        });
      }

      async function register() {
        const name = document.getElementById("name").value.trim();
        const username = document.getElementById("username").value.trim();
        const email = document.getElementById("email").value.trim();
        const phone = document.getElementById("phone").value.trim();
        const password = document.getElementById("password").value.trim();
        const confirmPassword = document
          .getElementById("confirmPassword")
          .value.trim();
        const errorDiv = document.getElementById("error");
        const successDiv = document.getElementById("success");

        errorDiv.innerText = "";
        successDiv.innerText = "";

        if (!name || !username || !email || !phone || !password || !confirmPassword) {
          errorDiv.innerText = "Semua field wajib diisi";
          return;
        }

        if (!/^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/.test(email)) {
          errorDiv.innerText = "Format email tidak valid";
          return;
        }

        if (!/^[0-9+\\-\\s]+$/.test(phone)) {
          errorDiv.innerText = "Nomor HP hanya boleh angka";
          return;
        }

        if (password !== confirmPassword) {
          errorDiv.innerText = "Password tidak sama";
          return;
        }

        const res = await fetch(
          `http://localhost:3000/users?username=${username}`
        );
        const data = await res.json();

        if (data.length > 0) {
          errorDiv.innerText = "Username sudah digunakan";
          return;
        }

        const newId = await generateUID();

        const photoFile = document.getElementById("photoFile").files?.[0];
        let photoData = "";

        if (photoFile) {
          if (!photoFile.type.startsWith("image/")) {
            errorDiv.innerText = "Foto harus berupa gambar";
            return;
          }
          if (photoFile.size > 300 * 1024) {
            errorDiv.innerText = "Ukuran foto maksimal 300KB";
            return;
          }
          photoData = await new Promise((resolve, reject) => {
            const reader = new FileReader();
            reader.onload = () => resolve(reader.result);
            reader.onerror = () => reject();
            reader.readAsDataURL(photoFile);
          }).catch(() => "");
        }

        try {
          await fetch("http://localhost:3000/users", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              id: newId,
              name: name,
              username: username,
              email: email,
              phone: phone,
              password: password,
              photoData: photoData,
              role: "user",
              active: true
            })
          });
        } catch (_) {
          errorDiv.innerText = "Gagal menyimpan data. Coba lagi.";
          return;
        }

        await addLog(
          "REG",
          "Register",
          username,
          newId,
          username
        );

        successDiv.innerText = "Register berhasil! Mengalihkan ke login...";
        setTimeout(() => {
          window.location.href = "login.html";
        }, 800);
      }
    </script>
  </body>
</html>
