<!DOCTYPE html>
<html>
  <head>
    <title>Login</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <link rel="stylesheet" href="style.css">
  </head>
  <body class="login-page">
    <div class="container login-wrap">
      <div class="row justify-content-center">
        <div class="col-12 col-lg-9">
          <div class="card shadow login-card">
            <div class="row g-0 login-shell">
              <div class="col-lg-6 login-showcase">
                <span class="login-badge">Mini DMS</span>
                <h3 class="mb-2 login-title">Portal Dokumen</h3>
                <p class="mb-4 login-subtitle">Kelola file, pengguna, dan aktivitas dalam satu dashboard.</p>
              </div>

              <div class="col-lg-6">
                <div class="card-body login-form-pane">
                  <h4 class="mb-1">Masuk Akun</h4>
                  <p class="text-muted mb-4">Gunakan username dan password yang terdaftar.</p>

                  <div class="mb-3">
                    <label for="username" class="login-label">Username</label>
                    <input type="text" id="username" class="form-control login-input" placeholder="Masukkan username">
                  </div>

                  <div class="mb-3">
                    <label for="password" class="login-label">Password</label>
                    <input type="password" id="password" class="form-control login-input" placeholder="Masukkan password">
                  </div>

                  <div id="error" class="text-danger mb-3 small"></div>

                  <button class="btn btn-primary w-100 login-btn" onclick="login()">
                    Login
                  </button>
                  <div class="text-center mt-3 login-register">
                    <a href="register.html">Belum punya akun? Register</a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function addLog(prefix, action) {
        const user = JSON.parse(localStorage.getItem("user"));
        const now = new Date();

        const day = String(now.getDate()).padStart(2, "0");
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const year = String(now.getFullYear()).slice(-2);

        const datePrefix = day + month + year;

        fetch("http://localhost:3000/logs")
          .then(res => res.json())
          .then(data => {
            const todayLogs = data.filter(
              log =>
                log.id &&
                log.id.startsWith(prefix + "-" + datePrefix)
            );

            const nextNumber = String(todayLogs.length + 1).padStart(3, "0");
            const newId = prefix + "-" + datePrefix + "-" + nextNumber;

            fetch("http://localhost:3000/logs", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id: newId,
                username: user.username,
                action: action,
                targetId: user.id,
                targetName: `${user.username}(${user.role})`,
                date: now.toLocaleString()
              })
            });
          });
      }

      function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        fetch(
          `http://localhost:3000/users?username=${username}&password=${password}`
        )
          .then(res => res.json())
          .then(data => {
            if (data.length > 0) {
              const user = data[0];

              if (user.active === false) {
                document.getElementById("error").innerText =
                  "Akun dinonaktifkan. Hubungi admin.";
                return;
              }

              localStorage.setItem("user", JSON.stringify(user));
              addLog("LGN", "Login");
              window.location.href = "dashboard.html";
            } else {
              document.getElementById("error").innerText =
                "Username atau password salah";
            }
          });
      }
    </script>
  </body>
</html>


