<!DOCTYPE html>
<html>
  <head>
    <title>Login</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-4">
          <div class="card shadow">
            <div class="card-body">
              <h4 class="text-center mb-4">Login</h4>

              <div class="mb-3">
                <label>Username</label>
                <input type="text" id="username" class="form-control">
              </div>

              <div class="mb-3">
                <label>Password</label>
                <input type="password" id="password" class="form-control">
              </div>

              <div id="error" class="text-danger mb-3"></div>

              <button class="btn btn-primary w-100" onclick="login()">
                Login
              </button>
              <div class="text-center mt-3">
                <a href="register.html">Belum punya akun? Register</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      function addLog(prefix, action) {
        const user = JSON.parse(localStorage.getItem("user"));
        const now = new Date();

        const day = String(now.getDate()).padStart(2, "0");
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const year = String(now.getFullYear()).slice(-2);

        const datePrefix = day + month + year;

        fetch("http://localhost:3000/logs")
          .then(res => res.json())
          .then(data => {
            const todayLogs = data.filter(
              log =>
                log.id &&
                log.id.startsWith(prefix + "-" + datePrefix)
            );

            const nextNumber = String(todayLogs.length + 1).padStart(3, "0");
            const newId = prefix + "-" + datePrefix + "-" + nextNumber;

            fetch("http://localhost:3000/logs", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                id: newId,
                username: user.username,
                action: action,
                date: now.toLocaleString()
              })
            });
          });
      }

      function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        fetch(
          `http://localhost:3000/users?username=${username}&password=${password}`
        )
          .then(res => res.json())
          .then(data => {
            if (data.length > 0) {
              const user = data[0];

              localStorage.setItem("user", JSON.stringify(user));
              addLog("LGN", "Login");
              window.location.href = "dashboard.html";
            } else {
              document.getElementById("error").innerText =
                "Username atau password salah";
            }
          });
      }
    </script>
  </body>
</html>
