<!DOCTYPE html>
<html>
  <head>
    <title>Login</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <link rel="stylesheet" href="style.css">
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div class="row justify-content-center">
        <div class="col-md-4">
          <div class="card shadow">
            <div class="card-body">
              <h4 class="text-center mb-1 login-title">Selamat Datang</h4>
              <p class="text-center mb-4">
                <span class="login-badge">Ini Web Testing</span>
              </p>

              <div class="mb-3">
                <label>Username</label>
                <input type="text" id="username" class="form-control">
              </div>

              <div class="mb-3">
                <label>Password</label>
                <input type="password" id="password" class="form-control">
              </div>

              <div id="error" class="text-danger mb-3"></div>

              <button class="btn btn-primary w-100" onclick="login()">
                Login
              </button>
              <div class="text-center mt-3">
                <a href="register.html">Belum punya akun? Register</a>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script>
      async function addLog(prefix, action) {
        const user = JSON.parse(localStorage.getItem("user"));
        const now = new Date();

        const day = String(now.getDate()).padStart(2, "0");
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const year = String(now.getFullYear()).slice(-2);

        const datePrefix = day + month + year;

        const res = await fetch("http://localhost:3000/logs");
        const data = await res.json();
        const todayLogs = data.filter(
          log =>
            log.id &&
            log.id.startsWith(prefix + "-" + datePrefix)
        );

        let maxNumber = 0;
        todayLogs.forEach(log => {
          const parts = (log.id || "").split("-");
          const number = parseInt(parts[2], 10) || 0;
          if (number > maxNumber) {
            maxNumber = number;
          }
        });

        const nextNumber = String(maxNumber + 1).padStart(3, "0");
        const newId = prefix + "-" + datePrefix + "-" + nextNumber;

        await fetch("http://localhost:3000/logs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: newId,
            username: user.username,
            action: action,
            targetId: user.id,
            targetName: `${user.username}(${user.role})`,
            date: now.toLocaleString()
          })
        });
      }

      async function login() {
        const username = document.getElementById("username").value;
        const password = document.getElementById("password").value;

        const res = await fetch(
          `http://localhost:3000/users?username=${username}&password=${password}`
        );
        const data = await res.json();

        if (data.length > 0) {
          const user = data[0];

          if (user.active === false) {
            document.getElementById("error").innerText =
              "Akun dinonaktifkan. Hubungi admin.";
            return;
          }

          localStorage.setItem("user", JSON.stringify(user));
          await addLog("LGN", "Login");
          window.location.href = "dashboard.html";
        } else {
          document.getElementById("error").innerText =
            "Username atau password salah";
        }
      }
    </script>
  </body>
</html>
