<!DOCTYPE html>
<html>
<head>
  <title>Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<div class="container mt-5">
  <div class="card shadow">
    <div class="card-body">
      <h4>Dashboard</h4>
      <p id="welcome"></p>

      <div id="adminMenu" class="mb-3"></div>
<a href="files.html" class="btn btn-success">File Managent</a>


      <button class="btn btn-danger" onclick="logout()">
Logout
</button>
    </div>
  </div>
</div>

<script>
const user = JSON.parse(localStorage.getItem("user"));

if (!user) {
  window.location.href = "login.html";
} else {
  document.getElementById("welcome").innerText =
    "Welcome, " + user.username + " (" + user.role + ")";

  if (user.role === "admin") {
    document.getElementById("adminMenu").innerHTML =
    `
      <a href="admin.html" class="btn btn-primary me-2">
        User Management
      </a>

      <a href="logs.html" class="btn btn-warning">
        Log Activity
      </a>
    `;
  }
}

// ===============================
// LOGOUT FUNCTION
// ===============================
async function logout() {

  const storedUser = localStorage.getItem("user");

  if (!storedUser) {
    window.location.href = "login.html";
    return;
  }

  const user = JSON.parse(storedUser);

  // Tunggu log selesai
  await addLog("LGT", "Logout", user.username);

  localStorage.removeItem("user");

  window.location.href = "login.html";
}


// ===============================
// ADD LOG FUNCTION
// ===============================
async function addLog(prefix, action, username) {

  const now = new Date();

  const day = String(now.getDate()).padStart(2, "0");
  const month = String(now.getMonth() + 1).padStart(2, "0");
  const year = String(now.getFullYear()).slice(-2);

  const datePrefix = day + month + year;

  const response = await fetch("http://localhost:3000/logs");
  const data = await response.json();

  const todayLogs = data.filter(log =>
    log.id &&
    log.id.startsWith(prefix + "-" + datePrefix)
  );

  const nextNumber =
    String(todayLogs.length + 1).padStart(3, "0");

  const newId =
    prefix + "-" + datePrefix + "-" + nextNumber;

  await fetch("http://localhost:3000/logs", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      id: newId,
      username: username,
      action: action,
      date: now.toLocaleString()
    })
  });
}

</script>

</body>
</html>
