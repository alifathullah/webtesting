<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    >
    <title>File Management</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <link rel="stylesheet" href="style.css">
    <style>
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div class="card shadow">
        <div class="card-header bg-white d-flex align-items-center">
          <div class="d-flex align-items-center">
            <a
              href="dashboard.html"
              class="text-dark me-2"
              style="text-decoration:none; font-size:20px;"
            >
              <i class="bi bi-arrow-left"></i>
            </a>
            <h4 class="mb-0">File Management</h4>
          </div>
        </div>
        <div class="card-body">
          <div id="message" class="alert d-none mb-3" role="alert"></div>

          <!-- File Table -->
          <div class="d-flex flex-wrap align-items-center justify-content-between mb-3">
            <div class="position-relative">
              <input
                type="text"
                id="search"
                class="form-control w-auto pe-4"
                placeholder="Search file..."
                onkeyup="loadFiles()"
                style="min-width: 240px;"
              >
              <button
                type="button"
                class="btn btn-sm btn-link text-muted position-absolute top-50 end-0 translate-middle-y me-2"
                onclick="clearFileSearch()"
                aria-label="Clear search"
              >
                <i class="bi bi-x-circle"></i>
              </button>
            </div>
            <button
              class="btn btn-primary"
              data-bs-toggle="modal"
              data-bs-target="#uploadModal"
            >
              Upload
            </button>
          </div>

          <div class="table-responsive">
            <table class="table align-middle">
              <thead class="table-header">
              <tr>
                <th>ID</th>
                <th>File Name</th>
                <th>Owner</th>
                <th>
                  <div class="d-flex align-items-center justify-content-between">
                    <span id="dateSortLabel">Date (Terbaru)</span>
                    <button
                      type="button"
                      class="btn btn-link p-0 ms-2"
                      onclick="toggleSort()"
                      aria-label="Toggle sort date"
                    >
                      <i id="dateSortIcon" class="bi bi-arrow-down"></i>
                    </button>
                  </div>
                </th>
                <th>Action</th>
              </tr>
              </thead>
              <tbody id="fileTable"></tbody>
            </table>
          </div>

          <div class="d-flex align-items-center justify-content-between">
            <div>
              <button class="btn btn-outline-secondary btn-sm" onclick="prevPage()">
                Prev
              </button>
              <button class="btn btn-outline-secondary btn-sm" onclick="nextPage()">
                Next
              </button>
            </div>
            <div class="text-muted" id="pageInfo"></div>
            <div>
              <select id="pageSize" class="form-select form-select-sm" onchange="setPageSize()">
                <option value="5">5 / page</option>
                <option value="10" selected>10 / page</option>
                <option value="20">20 / page</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- =========================
            MODAL UPLOAD
    ========================= -->
    <div class="modal fade" id="uploadModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Upload File</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <div class="mb-3">
              <label>Nama file</label>
              <input
                type="text"
                id="fileName"
                class="form-control"
                placeholder="Nama file"
              >
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">
              Cancel
            </button>
            <button class="btn btn-primary" onclick="uploadFile()">
              Upload
            </button>
          </div>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const user = JSON.parse(localStorage.getItem("user"));

      if (!user) {
        showMessage("Silakan login terlebih dahulu.", "danger");
        setTimeout(() => {
          window.location.href = "login.html";
        }, 800);
      }

      async function addLog(
        prefix,
        action,
        username,
        targetId = "-",
        targetName = "-"
      ) {
        const now = new Date();

        const day = String(now.getDate()).padStart(2, "0");
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const year = String(now.getFullYear()).slice(-2);

        const datePrefix = day + month + year;

        const response = await fetch("http://localhost:3000/logs");
        const data = await response.json();

        const todayLogs = data.filter(
          log =>
            log.id &&
            log.id.startsWith(prefix + "-" + datePrefix)
        );

        let maxNumber = 0;

        todayLogs.forEach(log => {
          const parts = log.id.split("-");
          const number = parseInt(parts[2]);

          if (number > maxNumber) {
            maxNumber = number;
          }
        });

        const nextNumber = String(maxNumber + 1).padStart(3, "0");
        const newId = prefix + "-" + datePrefix + "-" + nextNumber;

        await fetch("http://localhost:3000/logs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: newId,
            username: username,
            action: action,
            targetId: targetId,
            targetName: targetName,
            date: now.toLocaleString()
          })
        });
      }

      /* =======================
         LOAD FILES
      ======================= */
      let sortOrder = "desc";
      let currentPage = 1;
      let pageSize = 10;

      function showMessage(text, type = "success") {
        const el = document.getElementById("message");
        el.className = `alert alert-${type} mb-3`;
        el.innerText = text;
      }

      function setPageSize() {
        const value = parseInt(document.getElementById("pageSize").value, 10);
        pageSize = Number.isFinite(value) ? value : 10;
        currentPage = 1;
        loadFiles();
      }

      function prevPage() {
        if (currentPage > 1) {
          currentPage -= 1;
          loadFiles();
        }
      }

      function nextPage() {
        currentPage += 1;
        loadFiles();
      }

      function parseDateString(value) {
        if (!value) return new Date(0);
        const [datePart, timePart] = value.split(",");
        if (!datePart || !timePart) return new Date(0);

        const [day, month, year] = datePart.trim().split("/");
        const [hour, minute, second] = timePart.trim().split(".");

        const y = parseInt(year, 10);
        const m = parseInt(month, 10) - 1;
        const d = parseInt(day, 10);
        const h = parseInt(hour, 10);
        const min = parseInt(minute, 10);
        const s = parseInt(second, 10);

        return new Date(y, m, d, h, min, s);
      }

      function toggleSort() {
        sortOrder = sortOrder === "asc" ? "desc" : "asc";
        const label = sortOrder === "asc" ? "Terlama" : "Terbaru";
        document.getElementById("dateSortLabel").innerText = `Date (${label})`;
        const icon = document.getElementById("dateSortIcon");
        icon.className = sortOrder === "asc"
          ? "bi bi-arrow-up"
          : "bi bi-arrow-down";
        loadFiles();
      }

      function loadFiles() {
        const keyword =
          document.getElementById("search")?.value?.toLowerCase() || "";

        fetch("http://localhost:3000/files")
          .then(res => res.json())
          .then(data => {
            const table = document.getElementById("fileTable");
            table.innerHTML = "";

            const sorted = [...data].sort((a, b) => {
              const diff = parseDateString(a.date) - parseDateString(b.date);
              return sortOrder === "asc" ? diff : -diff;
            });

            const filtered = sorted.filter(f => {
              if (
                (user.role === "admin" || f.owner === user.username) &&
                f.name.toLowerCase().includes(keyword)
              ) {
                return true;
              }
              return false;
            });

            const totalPages = Math.max(1, Math.ceil(filtered.length / pageSize));
            if (currentPage > totalPages) currentPage = totalPages;

            const start = (currentPage - 1) * pageSize;
            const pageItems = filtered.slice(start, start + pageSize);

            pageItems.forEach(f => {
              table.innerHTML += `
                <tr>
                  <td>${f.id}</td>
                  <td>${f.name}</td>
                  <td>${f.owner}</td>
                  <td>${f.date}</td>
                  <td>
                    <button class="btn btn-success btn-sm" onclick="downloadFile('${f.name}')">
                      Download
                    </button>

                    <button class="btn btn-danger btn-sm" onclick="deleteFile('${f.id}')">
                      Delete
                    </button>
                  </td>
                </tr>
              `;
            });

            document.getElementById("pageInfo").innerText =
              `Page ${currentPage} / ${totalPages} (${filtered.length} items)`;
          })
          .catch(() => {
            showMessage("Gagal memuat data file", "danger");
          });
      }

      function clearFileSearch() {
        const input = document.getElementById("search");
        if (input) input.value = "";
        currentPage = 1;
        loadFiles();
      }

      /* =======================
         GENERATE FILE ID (FU)
      ======================= */
      async function generateFileId() {
        const now = new Date();

        const day = String(now.getDate()).padStart(2, "0");
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const year = String(now.getFullYear()).slice(-2);

        const datePrefix = day + month + year;

        try {
          const res = await fetch("http://localhost:3000/counters");
          const counters = await res.json();
          const fileByDate = counters?.fileByDate || {};
          const current = parseInt(fileByDate[datePrefix] || "0", 10) || 0;
          const next = current + 1;

          await fetch("http://localhost:3000/counters", {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              fileByDate: {
                ...fileByDate,
                [datePrefix]: next
              }
            })
          });

          const nextNumber = String(next).padStart(3, "0");
          return "FU-" + datePrefix + "-" + nextNumber;
        } catch (_) {
          // Fallback: hitung dari data file jika counters belum ada
          const res = await fetch("http://localhost:3000/files");
          const data = await res.json();

          const todayFiles = data.filter(
            f =>
              f.id &&
              f.id.startsWith("FU-" + datePrefix)
          );

          let maxNumber = 0;

          todayFiles.forEach(f => {
            const parts = f.id.split("-");
            const number = parseInt(parts[2]);

            if (number > maxNumber) {
              maxNumber = number;
            }
          });

          const nextNumber = String(maxNumber + 1).padStart(3, "0");
          return "FU-" + datePrefix + "-" + nextNumber;
        }
      }

      /* =======================
         UPLOAD FILE
      ======================= */
      async function uploadFile() {
        const fileNameInput = document.getElementById("fileName").value;

        if (!fileNameInput) {
        showMessage("Masukkan nama file!", "danger");
        return;
      }

        const newFileId = await generateFileId();

        await fetch("http://localhost:3000/files", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: newFileId,
            name: fileNameInput,
            owner: user.username,
            date: new Date().toLocaleString()
          })
        });

        // ðŸ”¥ LOG DENGAN ID & NAMA FILE
        await addLog(
          "FM",
          "Upload File",
          user.username,
          newFileId,
          fileNameInput
        );

        showMessage("File berhasil diupload", "success");

        document.getElementById("fileName").value = "";
        const modal = bootstrap.Modal.getInstance(
          document.getElementById("uploadModal")
        );
        if (modal) {
          modal.hide();
        }
        loadFiles();
      }

      /* =======================
         DELETE FILE
      ======================= */
      async function deleteFile(id) {
        // ambil dulu data file sebelum dihapus
        const res = await fetch(`http://localhost:3000/files/${id}`);
        const file = await res.json();

        await fetch(`http://localhost:3000/files/${id}`, {
          method: "DELETE"
        });

        // ðŸ”¥ LOG DELETE + TARGET
        await addLog(
          "FM",
          "Delete File",
          user.username,
          id,
          file.name
        );

        showMessage("File berhasil dihapus", "success");

        loadFiles();
      }

      /* =======================
         DOWNLOAD (dummy)
      ======================= */
      async function downloadFile(name) {
        let targetId = "-";
        try {
          const res = await fetch("http://localhost:3000/files");
          const files = await res.json();
          const found = files.find(f => f.name === name);
          if (found) {
            targetId = found.id;
          }
        } catch (_) {
          targetId = "-";
        }

        await addLog(
          "FM",
          "Download File",
          user.username,
          targetId,
          name
        );

        showMessage("Download file: " + name, "info");
      }

      loadFiles();
    </script>
  </body>
</html>
