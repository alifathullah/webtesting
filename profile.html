<!DOCTYPE html>
<html>
  <head>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css"
    >
    <title>Profile</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    >
    <link rel="stylesheet" href="style.css">
    <style>
      .avatar {
        width: 80px;
        height: 80px;
        object-fit: cover;
      }
      .avatar-placeholder {
        width: 80px;
        height: 80px;
      }
    </style>
  </head>
  <body class="bg-light">
    <div class="container mt-5">
      <div class="card shadow">
        <div class="card-header bg-white d-flex align-items-center">
          <a
            href="dashboard.html"
            class="text-dark me-2"
            style="text-decoration:none; font-size:20px;"
          >
            <i class="bi bi-arrow-left"></i>
          </a>
          <h4 class="mb-0">Profile</h4>
        </div>
        <div class="card-body">
          <div id="message" class="alert d-none mb-3" role="alert"></div>

          <div class="d-flex align-items-center gap-3 mb-3">
            <div class="position-relative">
              <img
                id="profileImage"
                src=""
                alt="Profile"
                class="rounded-circle border avatar d-none"
              >
              <div
                id="profilePlaceholder"
                class="rounded-circle border d-flex align-items-center justify-content-center text-muted avatar-placeholder"
              >
                <i class="bi bi-person-fill" style="font-size:32px;"></i>
              </div>
              <button
                type="button"
                class="btn btn-primary btn-sm position-absolute bottom-0 end-0 rounded-circle"
                id="photoBtn"
                aria-label="Ganti foto"
                style="width:32px; height:32px; padding:0; transform: translate(25%, 25%); border:2px solid #fff;"
              >
                <i class="bi bi-camera"></i>
              </button>
              <button
                type="button"
                class="btn btn-outline-danger btn-sm position-absolute bottom-0 start-0 rounded-circle"
                id="removePhotoBtn"
                aria-label="Hapus foto"
                style="width:32px; height:32px; padding:0; transform: translate(-25%, 25%); border:2px solid #fff;"
              >
                <i class="bi bi-trash"></i>
              </button>
            </div>
            <div class="small text-muted" id="profileName"></div>
            <input
              type="file"
              id="photoFile"
              class="d-none"
              accept="image/*"
            >
          </div>

          <form class="small">
            <div class="row g-2">
              <div class="col-md-6">
                <label class="form-label">Username</label>
                <input type="text" id="username" class="form-control form-control-sm" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Role</label>
                <input type="text" id="role" class="form-control form-control-sm" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Nama Lengkap</label>
                <input type="text" id="name" class="form-control form-control-sm" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Email</label>
                <input type="email" id="email" class="form-control form-control-sm" readonly>
              </div>
              <div class="col-md-6">
                <label class="form-label">Nomor HP</label>
                <input type="tel" id="phone" class="form-control form-control-sm" readonly>
              </div>
            </div>

            <div class="mt-3 d-flex flex-wrap gap-2 align-items-center">
              <button type="button" class="btn btn-primary btn-sm" id="editBtn">
                Edit
              </button>
              <button type="button" class="btn btn-outline-secondary btn-sm" id="changePasswordBtn">
                Change Password
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Edit Profile Modal -->
    <div class="modal fade" id="editProfileModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form onsubmit="saveProfile(event)">
            <div class="modal-header">
              <h5 class="modal-title">Edit Profile</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div id="editMessage" class="alert d-none mb-3" role="alert"></div>
              <div class="mb-2">
                <label class="form-label">Nama Lengkap</label>
                <input type="text" id="editName" class="form-control">
              </div>
              <div class="mb-2">
                <label class="form-label">Email</label>
                <input type="email" id="editEmail" class="form-control">
              </div>
              <div class="mb-2">
                <label class="form-label">Nomor HP</label>
                <input type="tel" id="editPhone" class="form-control">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <!-- Change Password Modal -->
    <div class="modal fade" id="changePasswordModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form onsubmit="savePassword(event)">
            <div class="modal-header">
              <h5 class="modal-title">Change Password</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div id="cpMessage" class="alert d-none mb-3" role="alert"></div>
              <div class="mb-2">
                <label class="form-label">Password Baru</label>
                <input type="password" id="cpNewPassword" class="form-control">
              </div>
              <div class="mb-2">
                <label class="form-label">Konfirmasi Password</label>
                <input type="password" id="cpConfirmPassword" class="form-control">
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                Cancel
              </button>
              <button type="submit" class="btn btn-primary">
                Save
              </button>
            </div>
          </form>
        </div>
      </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      const user = JSON.parse(localStorage.getItem("user"));
      const messageEl = document.getElementById("message");

      if (!user) {
        messageEl.className = "alert alert-danger mb-3";
        messageEl.innerText = "Silakan login terlebih dahulu.";
        setTimeout(() => {
          window.location.href = "login.html";
        }, 800);
      }

      const fields = {
        username: document.getElementById("username"),
        name: document.getElementById("name"),
        email: document.getElementById("email"),
        phone: document.getElementById("phone"),
        role: document.getElementById("role")
      };

      const imgEl = document.getElementById("profileImage");
      const placeholderEl = document.getElementById("profilePlaceholder");
      const editBtn = document.getElementById("editBtn");
      const photoBtn = document.getElementById("photoBtn");
      const removePhotoBtn = document.getElementById("removePhotoBtn");
      const photoFile = document.getElementById("photoFile");
      const profileName = document.getElementById("profileName");
      const editName = document.getElementById("editName");
      const editEmail = document.getElementById("editEmail");
      const editPhone = document.getElementById("editPhone");
      const editModalEl = document.getElementById("editProfileModal");
      const editModal = new bootstrap.Modal(editModalEl);
      const editMessageEl = document.getElementById("editMessage");
      const changePasswordBtn = document.getElementById("changePasswordBtn");
      const changePasswordModalEl = document.getElementById("changePasswordModal");
      const changePasswordModal = new bootstrap.Modal(changePasswordModalEl);
      const cpMessageEl = document.getElementById("cpMessage");
      const cpNewPassword = document.getElementById("cpNewPassword");
      const cpConfirmPassword = document.getElementById("cpConfirmPassword");

      function showMessage(text, type = "success") {
        messageEl.className = `alert alert-${type} mb-3`;
        messageEl.innerText = text;
      }

      function showEditMessage(text, type = "danger") {
        editMessageEl.className = `alert alert-${type} mb-3`;
        editMessageEl.innerText = text;
      }

      function showCpMessage(text, type = "danger") {
        cpMessageEl.className = `alert alert-${type} mb-3`;
        cpMessageEl.innerText = text;
      }

      function showPlaceholder() {
        imgEl.classList.add("d-none");
        placeholderEl.classList.remove("d-none");
      }

      function setPreview(data) {
        if (!data) {
          showPlaceholder();
          return;
        }
        imgEl.src = data;
        imgEl.classList.remove("d-none");
        placeholderEl.classList.add("d-none");
      }

      function fillForm() {
        fields.username.value = user.username || "";
        fields.name.value = user.name || "";
        fields.email.value = user.email || "";
        fields.phone.value = user.phone || "";
        fields.role.value = user.role || "";
        profileName.innerText = user.name || user.username || "Profile";
        setPreview(user.photoData || "");
      }

      function openEditModal() {
        editMessageEl.className = "alert d-none mb-3";
        editMessageEl.innerText = "";
        editName.value = user.name || "";
        editEmail.value = user.email || "";
        editPhone.value = user.phone || "";
        editModal.show();
      }

      function openChangePasswordModal() {
        cpMessageEl.className = "alert d-none mb-3";
        cpMessageEl.innerText = "";
        cpNewPassword.value = "";
        cpConfirmPassword.value = "";
        changePasswordModal.show();
      }

      async function savePhotoData(action = "Update Photo") {
        try {
          await fetch(`http://localhost:3000/users/${user.id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              photoData: user.photoData || ""
            })
          });
        } catch (_) {
          showMessage("Gagal menyimpan foto profil", "danger");
          return;
        }

        localStorage.setItem("user", JSON.stringify(user));
        await addLog(
          "PRF",
          action,
          user.username,
          user.id,
          user.username
        );
        const successMessage =
          action === "Remove Photo"
            ? "Foto profil berhasil dihapus"
            : "Foto profil berhasil diperbarui";
        showMessage(successMessage, "success");
      }

      function handlePhotoFile() {
        const file = photoFile.files?.[0];
        if (!file) return;

        if (!file.type.startsWith("image/")) {
          showMessage("File harus berupa gambar", "danger");
          photoFile.value = "";
          return;
        }
        if (file.size > 300 * 1024) {
          showMessage("Ukuran foto maksimal 300KB", "danger");
          photoFile.value = "";
          return;
        }

        const reader = new FileReader();
          reader.onload = async () => {
            user.photoData = reader.result;
            setPreview(user.photoData);
            await savePhotoData("Update Photo");
          };
          reader.readAsDataURL(file);
        }

      async function removePhoto() {
        user.photoData = "";
        setPreview("");
        await savePhotoData("Remove Photo");
      }

      async function saveProfile(event) {
        event.preventDefault();

        const name = editName.value.trim();
        const email = editEmail.value.trim();
        const phone = editPhone.value.trim();

        if (!name) {
          showEditMessage("Nama lengkap wajib diisi");
          return;
        }
        if (email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
          showEditMessage("Format email tidak valid");
          return;
        }
        if (phone && !/^[0-9+\-\s]+$/.test(phone)) {
          showEditMessage("Nomor HP hanya boleh angka");
          return;
        }

        try {
          await fetch(`http://localhost:3000/users/${user.id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              name,
              email,
              phone,
              photoData: user.photoData || ""
            })
          });
        } catch (_) {
          showEditMessage("Gagal menyimpan profile. Coba lagi.");
          return;
        }

        user.name = name;
        user.email = email;
        user.phone = phone;
        localStorage.setItem("user", JSON.stringify(user));

        await addLog(
          "PRF",
          "Update Profile",
          user.username,
          user.id,
          user.username
        );
        showMessage("Profile berhasil diperbarui", "success");
        fillForm();
        editModal.hide();
      }

      async function addLog(prefix, action, username, targetId = "-", targetName = "-") {
        const now = new Date();

        const day = String(now.getDate()).padStart(2, "0");
        const month = String(now.getMonth() + 1).padStart(2, "0");
        const year = String(now.getFullYear()).slice(-2);

        const datePrefix = day + month + year;

        const response = await fetch("http://localhost:3000/logs");
        const data = await response.json();

        const todayLogs = data.filter(
          log =>
            log?.id &&
            log.id.startsWith(prefix + "-" + datePrefix)
        );

        let maxNumber = 0;
        todayLogs.forEach(log => {
          const parts = (log.id || "").split("-");
          const number = parseInt(parts[2], 10) || 0;
          if (number > maxNumber) {
            maxNumber = number;
          }
        });

        const nextNumber = String(maxNumber + 1).padStart(3, "0");
        const newId = prefix + "-" + datePrefix + "-" + nextNumber;

        await fetch("http://localhost:3000/logs", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            id: newId,
            username: username,
            action: action,
            targetId: targetId,
            targetName: targetName,
            date: now.toLocaleString()
          })
        });
      }

      async function savePassword(event) {
        event.preventDefault();

        const newPassword = cpNewPassword.value.trim();
        const confirmPassword = cpConfirmPassword.value.trim();

        if (!newPassword || !confirmPassword) {
          showCpMessage("Semua field wajib diisi");
          return;
        }
        if (newPassword !== confirmPassword) {
          showCpMessage("Password tidak sama");
          return;
        }

        try {
          await fetch(`http://localhost:3000/users/${user.id}`, {
            method: "PATCH",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ password: newPassword })
          });
        } catch (_) {
          showCpMessage("Gagal menyimpan password. Coba lagi.");
          return;
        }

        user.password = newPassword;
        localStorage.setItem("user", JSON.stringify(user));

        await addLog(
          "CPW",
          "Change Password",
          user.username,
          user.id,
          user.username
        );

        showMessage("Password berhasil diubah", "success");
        changePasswordModal.hide();
      }

      editBtn.addEventListener("click", openEditModal);
      changePasswordBtn.addEventListener("click", openChangePasswordModal);
      photoBtn.addEventListener("click", () => photoFile.click());
      removePhotoBtn.addEventListener("click", removePhoto);
      photoFile.addEventListener("change", handlePhotoFile);

      fillForm();
    </script>
  </body>
</html>
